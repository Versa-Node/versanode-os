name: VersaNode OS Build & Release (pi-gen)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (branch or tag)"
        default: "main"
        required: true
      release:
        description: "Publish GitHub Release?"
        type: boolean
        default: true
      upload_artifacts:
        description: "Upload build artifacts?"
        type: boolean
        default: true

concurrency:
  group: versanode-os-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ§¹ Free up disk space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: ğŸ§½ Extra prune & show free space
        run: |
          docker system prune -af || true
          sudo rm -rf /usr/local/lib/android /opt/ghc /usr/share/dotnet /opt/hostedtoolcache || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: ğŸ“¦ Checkout repo with submodules
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          submodules: recursive
          fetch-depth: 0

      - name: ğŸ” Verify submodules and config presence
        run: |
          set -euo pipefail
          [ -d pi-gen ] || { echo "::error::pi-gen missing"; exit 2; }
          [ -d versanode-os-kmods ] || { echo "::error::versanode-os-kmods missing"; exit 3; }
          [ -d versanode-os-usermods ] || { echo "::error::versanode-os-usermods missing"; exit 4; }
          [ -f config ] || { echo "::error::Missing root config file!"; exit 5; }
          [ -f scripts/build.sh ] || { echo "::error::Missing scripts/build.sh"; exit 6; }

          echo "âœ… Repository layout verified."
          echo "---- config preview ----"
          sed -n '1,40p' config

      - name: ğŸ”§ Make scripts executable
        run: chmod +x ./scripts/build.sh || true

      - name: ğŸ—ï¸ Run full build script
        run: |
          ./scripts/build.sh

      - name: ğŸ“‚ Collect build artifacts
        run: |
          mkdir -p artifacts
          cp -v pi-gen/deploy/*.{img,img.xz,bmap,sha256,zip} artifacts/ 2>/dev/null || true
          ls -lh artifacts || true

      - name: â¬†ï¸ Upload artifacts
        if: ${{ inputs.upload_artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: versanode-os-build-${{ github.run_number }}
          path: artifacts/*

      - name: Publish Release â€” VersaNode OS
        if: ${{ inputs.release }}
        uses: softprops/action-gh-release@v2
        with:
          name: "VersaNode OS Build #${{ github.run_number }}"
          tag_name: "build-${{ github.run_number }}"
          files: artifacts/*
          body: |
            ###  Automated Release â€” VersaNode OS
            This release was automatically generated by the CI pipeline.

            **Build Details**
            - ğŸ§¾ **Branch:** `${{ inputs.ref }}`
            - âš™ï¸ **Run ID:** `${{ github.run_id }}`
            - ğŸ§± **Build Number:** `${{ github.run_number }}`
            - ğŸ“¦ **Artifacts:** See attached build outputs under â€œAssetsâ€.

            ---
            ğŸ’¡ *This release may include new kernel, service, or web UI updates depending on the pipeline stage.*
