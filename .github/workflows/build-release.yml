name: Build & Release (pi-gen)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (branch or tag)"
        default: "main"
        required: true
      release:
        description: "Publish GitHub Release?"
        type: boolean
        default: true
      upload_artifacts:
        description: "Upload build artifacts?"
        type: boolean
        default: true
      arch:
        description: "Architecture (arm64 only here)"
        default: "arm64"
        required: true
      release_codename:
        description: "Raspberry Pi OS release (bookworm or trixie)"
        default: "trixie"
        required: true
      variant:
        description: "Image size (lite|normal|full)"
        default: "lite"
        required: true

concurrency:
  group: pigen-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Free up disk space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Extra prune & show free space
        run: |
          docker system prune -af || true
          sudo rm -rf /usr/local/lib/android /opt/ghc /usr/share/dotnet /opt/hostedtoolcache || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          submodules: recursive
          fetch-depth: 0

      - name: Install pi-gen host dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            coreutils quilt parted qemu-user-static debootstrap zerofree zip dosfstools e2fsprogs \
            libarchive-tools libcap2-bin grep rsync xz-utils file git curl bc gpg pigz xxd bmap-tools \
            kpartx kmod arch-test ca-certificates

      - name: Ensure pi-gen exists (clone correct branch)
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "pi-gen" ]; then
            echo "Found existing ./pi-gen"
          else
            BRANCH="master"
            if [ "${{ inputs.arch }}" = "arm64" ]; then
              BRANCH="arm64"
            fi
            echo "Cloning RPi-Distro/pi-gen branch: ${BRANCH}"
            git clone --depth 1 --branch "${BRANCH}" https://github.com/RPi-Distro/pi-gen.git
          fi

      - name: Write effective config
        shell: bash
        run: |
          set -euo pipefail
          : > config.effective
          echo "ARCH=arm64" >> config.effective
          echo "RELEASE=${{ inputs.release_codename }}" >> config.effective
          echo "ENABLE_SSH=1" >> config.effective
          echo "FIRST_USER_NAME=pi" >> config.effective
          echo "FIRST_USER_PASS=raspberry" >> config.effective
          echo "DISABLE_FIRST_BOOT_USER_RENAME=1" >> config.effective
          echo "DEBIAN_FRONTEND=noninteractive" >> config.effective
          echo "APT_LISTCHANGES_FRONTEND=none" >> config.effective
          echo "DEPLOY_COMPRESSION=xz" >> config.effective
          echo "COMPRESSION_LEVEL=6" >> config.effective
          echo "DEPLOY_ZIP=0" >> config.effective
          echo "USE_QEMU=1" >> config.effective
          echo "IMG_NAME=versanode-os" >> config.effective
          echo "DEPLOY_MINIMIZEFS=0" >> config.effective
          echo "ROOT_MARGIN=256" >> config.effective
          case "${{ inputs.variant }}" in
            lite)   STAGES="stage0 stage1 stage2 export-image"; SIZE=4096 ;;
            normal) STAGES="stage0 stage1 stage2 stage3 stage4 export-image"; SIZE=6144 ;;
            full)   STAGES="stage0 stage1 stage2 stage3 stage4 stage5 export-image"; SIZE=8192 ;;
            *) echo "Unknown variant"; exit 1 ;;
          esac
          echo "STAGE_LIST=\"${STAGES}\"" >> config.effective
          echo "TARGET_IMAGE_SIZE=${SIZE}" >> config.effective
          echo "---- EFFECTIVE CONFIG ----"
          cat config.effective

      - name: Inject export-image precheck (guards ROOTFS/BOOTFS and sizing)
        working-directory: pi-gen
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p export-image/00-precheck
          cat > export-image/00-precheck/00-run.sh <<'SH'
          #!/bin/bash -eu
          echo "[precheck] entering export-image precheck"
          
          : "${IMG_NAME:?IMG_NAME not set}"
          : "${WORK_DIR:?WORK_DIR not set}"
          : "${IMG_DATE:=$(date -u +%Y-%m-%d)}"
          
          BASE="${WORK_DIR}/${IMG_DATE}-${IMG_NAME}"
          
          # Find last stage with rootfs
          LAST=""
          LAST_STAGE=""
          for s in stage5 stage4 stage3 stage2 stage1 stage0; do
            if [ -d "${BASE}/${s}/rootfs" ]; then
              LAST="${BASE}/${s}/rootfs"
              LAST_STAGE="${s}"
              break
            fi
          done
          
          if [ -z "${LAST}" ]; then
            echo "[precheck] ERROR: no stage*/rootfs under ${BASE}" >&2
            exit 94
          fi
          
          # Export sane directories if unset
          export ROOTFS_DIR="${ROOTFS_DIR:-${LAST}}"
          if [ -d "${ROOTFS_DIR}/boot" ]; then
            export BOOTFS_DIR="${BOOTFS_DIR:-${ROOTFS_DIR}/boot}"
          fi
          
          # Provide export-image symlinks some scripts expect
          mkdir -p "${BASE}/export-image"
          [ -e "${BASE}/export-image/rootfs" ] || ln -s "${ROOTFS_DIR}" "${BASE}/export-image/rootfs"
          if [ -n "${BOOTFS_DIR:-}" ]; then
            [ -e "${BASE}/export-image/bootfs" ] || ln -s "${BOOTFS_DIR}" "${BASE}/export-image/bootfs"
          fi
          
          # Guarantee a non-empty TARGET_IMAGE_SIZE
          if [ -z "${TARGET_IMAGE_SIZE:-}" ]; then
            export TARGET_IMAGE_SIZE=4096
            echo "[precheck] TARGET_IMAGE_SIZE defaulted to 4096"
          fi
          
          echo "[precheck] IMG_DATE=${IMG_DATE} IMG_NAME=${IMG_NAME}"
          echo "[precheck] WORK_DIR=${WORK_DIR}"
          echo "[precheck] LAST_STAGE=${LAST_STAGE}"
          echo "[precheck] ROOTFS_DIR=${ROOTFS_DIR}"
          echo "[precheck] BOOTFS_DIR=${BOOTFS_DIR:-<none>}"
          echo "[precheck] TARGET_IMAGE_SIZE=${TARGET_IMAGE_SIZE}"
          SH
          chmod +x export-image/00-precheck/00-run.sh
          echo "Injected export-image/00-precheck/00-run.sh"

      - name: Build image with pi-gen (host ./build.sh)
        working-directory: pi-gen
        shell: bash
        env:
          PI_GEN_DEBUG: "1"
        run: |
          set -euo pipefail
          sudo CLEAN=1 ./build.sh -c ../config.effective

      - name: Show deploy contents
        shell: bash
        run: |
          echo "Contents of pi-gen/deploy:"
          ls -lah pi-gen/deploy || true

      - name: Upload artifacts (.img.xz)
        if: ${{ inputs.upload_artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: versanode-os-${{ inputs.release_codename }}-${{ inputs.arch }}-${{ inputs.variant }}
          path: pi-gen/deploy/*.img.xz
          if-no-files-found: error
          compression-level: 9

      - name: Create GitHub Release (attach .img.xz)
        if: ${{ inputs.release }}
        uses: softprops/action-gh-release@v2
        with:
          name: "versanode-os ${{ inputs.release_codename }} (${{ inputs.arch }}) â€” ${{ inputs.variant }}"
          draft: false
          prerelease: false
          tag_name: "build-${{ github.run_number }}"
          files: pi-gen/deploy/*.img.xz
